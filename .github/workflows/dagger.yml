name: Run Dagger pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger, as per instructions

jobs:
  dagger:
    name: Run Dagger pipeline
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      # --- DVC AND PYTHON SETUP ON THE GA RUNNER (SHELL) ---
      
      - name: Setup Python on Runner
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install DVC and Dependencies (SHELL)
        run: |
          pip install dvc

      - name: DVC Pull Data and Copy to Dagger Source
        working-directory: notebooks/ # We run from the DVC root
        run: |
          # 1. Execute DVC pull
          dvc pull

          # 2. Copy the pulled data from the DVC artifact folder (notebooks/artifacts)
          #    to the Dagger source folder (go/python-files/artifacts)
          mkdir -p ../go/python-files/artifacts
          cp -r artifacts/. ../go/python-files/artifacts/

      # --- DAGGER EXECUTION (Using the Official Action) ---

      - name: Run Dagger Pipeline
        # This action handles Dagger CLI installation and PATH configuration
        uses: dagger/dagger-for-github@v8.2.0 
        with:
          workdir: go
          verb: run
          args: go run pipeline.go # Executes your main Go program
          version: "0.19.6" # Use the specified version or 'latest'
          
      # --- FINAL ARTIFACT UPLOAD (CRITICAL REQUIREMENT) ---

      # The dagger action successfully ran pipeline.go, which created the 'go/model' folder.
      # We now upload that folder.
      - name: Upload Model Artifact
        uses: actions/upload-artifact@v4
        with:
          name: model
          path: go/model/ # Path must be relative to the repo root
          if-no-files-found: error