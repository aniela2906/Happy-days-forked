name: MLOps Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'go/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs: # <-- Main jobs block
  
  # Job 1: BUILD-DEPLOY (ID used for dependencies)
  build-deploy: # <-- CORRECTED ID (Was 'dagger', now matches 'needs' in job 2)
    name: Build and Deploy Model
    runs-on: ubuntu-latest

    outputs:
      # Renaming this step ID to align with standard practice
      run_id: ${{ steps.get-run-id.outputs.run_id }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      # --- DVC AND PYTHON SETUP ON THE GA RUNNER (SHELL) ---
      
      - name: Setup Python on Runner
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install DVC and Dependencies (SHELL)
        run: |
          pip install dvc
          pip install -r go/python-files/requirements.txt # Add this line to install all other dependencies

      - name: DVC Pull Data and Copy to Dagger Source
        working-directory: notebooks/
        run: |
          # 1. Execute DVC pull
          dvc pull

          # 2. Copy the pulled data to the Dagger source folder
          mkdir -p ../go/python-files/artifacts
          cp -r artifacts/. ../go/python-files/artifacts/

      # --- DAGGER EXECUTION ---

      - name: Run Dagger Pipeline
        uses: dagger/dagger-for-github@v8.2.0 
        with:
          workdir: go
          verb: run
          args: go run pipeline.go 
          version: "0.19.8" 
          
      # --- RUN ID CAPTURE (Missing Step Added) ---
      - name: Get MLflow Run ID
        id: get-run-id 
        run: |
          # The file is exported by Dagger to go/model/mlflow_run_id.txt
          RUN_ID=$(cat go/model/mlflow_run_id.txt)
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT 
          
      # --- FINAL ARTIFACT UPLOAD ---
      - name: Upload Model Artifact
        uses: actions/upload-artifact@v4
        with:
          name: model
          path: go/model/ 
          if-no-files-found: error

  # ----------------------------------------------------------------------
  
  # Job 2: TEST-INFERENCE (Must be defined at the same level as 'build-deploy')
  test-inference: # <-- CORRECTED INDENTATION: Aligned with 'build-deploy'
    name: Inference Test
    runs-on: ubuntu-latest
    needs: build-deploy # <-- Dependency matches the Job 1 ID
    
    env:
      TRAINING_RUN_ID: ${{ needs.build-deploy.outputs.run_id }} 
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # 1. Setup Python Environment
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12' 

      # Install the dependencies needed for inference
      - name: Install Test Dependencies
        run: pip install -r go/python-files/requirements.txt 

      # 2. Download Artifacts
      - name: Download Model Artifact
        uses: actions/download-artifact@v4
        with:
          name: model
          path: model/ 

      # 3. Execute Strict Inference Test
      - name: Execute Inference Test
        run: python go/python-files/test_inference.py