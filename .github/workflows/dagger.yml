name: Dagger CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      # --- DVC AND PYTHON SETUP ON THE GA RUNNER (SHELL) ---
      
      - name: Setup Python on Runner
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install DVC and Dependencies (SHELL)
        run: |
          # Install DVC on the runner for the data pull step
          pip install dvc

      - name: DVC Pull Data and Copy to Dagger Source
        working-directory: notebooks/ # CRITICAL: Run DVC from its configuration root
        run: |
          # 1. Execute DVC pull
          dvc pull

          # 2. Copy the pulled data from the DVC artifact folder (notebooks/artifacts)
          #    to the Dagger source folder (go/python-files/artifacts)
          mkdir -p ../go/python-files/artifacts
          cp -r artifacts/. ../go/python-files/artifacts/

      # --- DAGGER EXECUTION SETUP ---

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22' 

      - name: Install Dagger CLI
        # Return to the shell installation but use GitHub's environment file 
        # to ensure the path persists across steps.
        run: |
          # Install Dagger CLI
          curl -L https://dl.dagger.io/dagger/install.sh | sh
          
          # CRITICAL FIX: Add the installation directory to the runner's PATH 
          # using the official GitHub environment file method.
          echo "$HOME/.dagger/bin" >> $GITHUB_PATH
        
      - name: Execute Dagger Pipeline (Go program)
        working-directory: go/
        # This executes the pipeline.go, which sets up the container, 
        # installs Python requirements, runs train_model.py, and exports the 'model' folder.
        run: |
          go mod tidy
          dagger call build
          
      # --- FINAL ARTIFACT UPLOAD (CRITICAL REQUIREMENT) ---

      - name: Upload Model Artifact
        uses: actions/upload-artifact@v4
        with:
          name: model
          path: model/  # This directory was created by the 'dagger call build' step
          if-no-files-found: error